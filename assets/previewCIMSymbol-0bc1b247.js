import{dC as m,dr as S,dD as V,dq as u,dx as q}from"./index-f5157718.js";import{a as b}from"./CIMSymbolHelper-a4ca21cf.js";import{CIMSymbolRasterizer as D}from"./CIMSymbolRasterizer-987e0dd0.js";import{y as E}from"./OverrideHelper-a2a5ba17.js";import"./BidiEngine-664145a5.js";import"./fontUtils-169c9d42.js";import"./OptimizedGeometry-4a66a431.js";import"./memoryEstimations-e8cfae6e.js";import"./GeometryUtils-e2c839d5.js";import"./rasterizingUtils-04255511.js";import"./floatRGBA-d388c598.js";import"./Rect-ea14f53a.js";import"./BoundingBox-dc5b3050.js";import"./CIMResourceManager-7067ff29.js";import"./quantizationUtils-4be91068.js";const d=new D(null),p=m(S.size),G=m(S.maxSize),M=m(S.lineWidth),U=1;async function k(o,e,s){const i=e==null?void 0:e.size;let t=i!=null&&typeof i=="object"&&"width"in i?i.width:i,r=i!=null&&typeof i=="object"&&"height"in i?i.height:i;if(t==null||r==null)if(s==="esriGeometryPolygon")t=r=e.maxSize?Math.min(e.maxSize,p):p;else{const a=await A(o,e,s);a&&(t=a.width,r=a.height),s==="esriGeometryPolyline"&&(t=e.maxSize?Math.min(e.maxSize,M):M),t=t!=null&&isFinite(t)?Math.min(t,G):p,r=r!=null&&isFinite(r)?Math.max(Math.min(r,G),U):p}return e.style==="legend"&&s==="esriGeometryPolyline"&&(t=M),{width:t,height:r}}async function A(o,e,s){const{feature:i,fieldMap:t,viewParams:r}=e.cimOptions||e,a=await E.resolveSymbolOverrides(o.data,i,null,t,s,null,r);if(!a)return null;(o=o.clone()).data={type:"CIMSymbolReference",symbol:a},o.data.primitiveOverrides=void 0;const l=[];return b.fetchResources(a,d.resourceManager,l),b.fetchFonts(a,d.resourceManager,l),l.length>0&&await Promise.all(l),b.getEnvelope(a,null,d.resourceManager)}async function ie(o,e={}){var z,P;const{node:s,opacity:i,symbolConfig:t}=e,r=t!=null&&typeof t=="object"&&"isSquareFill"in t&&t.isSquareFill,a=e.cimOptions||e,l=a.geometryType||V((z=o==null?void 0:o.data)==null?void 0:z.symbol),n=await k(o,e,l),{feature:I,fieldMap:L}=a,F=e!=null&&e.geometry||r||l!=="esriGeometryPolygon"?"preview":"legend";let v=n;const x=n;if(e!=null&&e.geometry&&(l==="esriGeometryPolygon"||l==="esriGeometryPolyline")&&(u(n.width)<200||u(n.height)<200)){const R=n.width>n.height?m(200)*n.height/n.width:m(200);v={width:n.width>n.height?m(200):m(200)*n.width/n.height,height:R}}const f=await d.rasterizeCIMSymbolAsync(o,I,v,F,L,l,null,a.viewParams,a.allowScalingUp,(P=e==null?void 0:e.geometry)==null?void 0:P.toJSON());if(!f)return null;const{width:O,height:j}=f,c=document.createElement("canvas");c.width=O,c.height=j,c.getContext("2d").putImageData(f,0,0);const g=u(x.width),w=u(x.height),h=new Image(g,w);h.src=c.toDataURL(),h.ariaLabel=e.ariaLabel??null,h.alt=e.ariaLabel??"",i!=null&&(h.style.opacity=`${i}`);let y=h;if(e.effectView!=null){const C={shape:{type:"image",x:0,y:0,width:g,height:w,src:h.src},fill:null,stroke:null,offset:[0,0]};y=q([[C]],[g,w],{effectView:e.effectView,ariaLabel:e.ariaLabel})}return s&&y&&s.appendChild(y),y}export{ie as previewCIMSymbol};
