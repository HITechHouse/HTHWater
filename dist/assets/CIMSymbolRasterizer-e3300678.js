import{i as F}from"./CIMResourceManager-a89809d8.js";import{a as D,u as T,h as q}from"./CIMSymbolHelper-4cdc79b5.js";import{y as A}from"./OverrideHelper-4e9baadc.js";import{T as S,R as G}from"./rasterizingUtils-e5dcff2c.js";import{dD as z}from"./index-ee1133ea.js";import"./fontUtils-c7503a97.js";import"./BidiEngine-664145a5.js";import"./OptimizedGeometry-3060442a.js";import"./memoryEstimations-c448ab60.js";import"./GeometryUtils-592d7c77.js";import"./Rect-ea14f53a.js";import"./BoundingBox-7e817107.js";import"./quantizationUtils-3e5cef60.js";import"./floatRGBA-4bee2cac.js";const L=96/72;class tt{constructor(m){this._spatialReference=m,this._imageDataCanvas=null,this._cimResourceManager=new F}get _canvas(){return this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas")),this._imageDataCanvas}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(m,n,s,M,I,a,c,l,y,x){if(!m)return null;const{data:d}=m;if(!d||d.type!=="CIMSymbolReference"||!d.symbol)return null;const{symbol:v}=d;a||(a=z(v));const o=await A.resolveSymbolOverrides(d,n,this._spatialReference,I,a,c,l),w=this._cimResourceManager,f=[];D.fetchResources(o,w,f),D.fetchFonts(o,w,f),f.length>0&&await Promise.all(f);const{width:e,height:h}=s;let b=k(a,e,h,M,x);const t=D.getEnvelope(o,b,w);if(!t)return null;t.x===1/0&&(t.x=e+2),t.y===1/0&&(t.y=-h/2),t.width===-1/0&&(t.width=e),t.height===-1/0&&(t.height=h);let g=1,_=0,C=0;switch(v.type){case"CIMPointSymbol":case"CIMTextSymbol":{let i=1;t.width>e&&(i=e/t.width);let r=1;t.height>h&&(r=h/t.height),M==="preview"&&(t.width<e&&(i=e/t.width),t.height<h&&(r=h/t.height)),g=Math.min(i,r),_=t.x+t.width/2,C=t.y+t.height/2}break;case"CIMLineSymbol":if(x){C=t.y+t.height/2,_=t.x+t.width/2;const i=t.width-e,r=t.height-h;b={paths:S(b.paths,{xmin:-1*t.width/2+i,xmax:t.width/2-i,ymin:-1*t.height/2+r,ymax:t.height/2-r,width:t.width-2*i,height:t.height-2*r})}}else{(y||t.height>h)&&(g=h/t.height),C=t.y+t.height/2;const i=t.x*g+e/2,r=(t.x+t.width)*g+e/2,{paths:R}=b;R[0][0][0]-=i/g,R[0][2][0]-=(r-e)/g}break;case"CIMPolygonSymbol":if(x){C=t.y+t.height/2,_=t.x+t.width/2;const i=t.width-e,r=t.height-h;b={paths:S(b.rings,{xmin:-1*t.width/2+i,xmax:t.width/2-i,ymin:-1*t.height/2+r,ymax:t.height/2-r,width:t.width-2*i,height:t.height-2*r})}}else{_=t.x+t.width/2,C=t.y+t.height/2;const i=t.x*g+e/2,r=(t.x+t.width)*g+e/2,R=t.y*g+h/2,P=(t.y+t.height)*g+h/2,{rings:u}=b;i<0&&(u[0][0][0]-=i,u[0][3][0]-=i,u[0][4][0]-=i),R<0&&(u[0][0][1]+=R,u[0][1][1]+=R,u[0][4][1]+=R),r>e&&(u[0][1][0]-=r-e,u[0][2][0]-=r-e),P>h&&(u[0][2][1]+=P-h,u[0][3][1]+=P-h)}}const E={type:"cim",data:{type:"CIMSymbolReference",symbol:o}};return this.rasterize(E,e,h,_,C,g,a,1,b)}rasterize(m,n,s,M,I,a,c,l=0,y=null,x=window.devicePixelRatio||1){const{data:d}=m;if(!d||d.type!=="CIMSymbolReference"||!d.symbol)return null;const{symbol:v}=d,o=this._canvas,w=x*L;o.width=n*w,o.height=s*w,c||(c=z(v)),y||(y=k(c,n,s,"legend")),o.width+=2*l,o.height+=2*l;const f=o.getContext("2d",{willReadFrequently:!0}),e=q.createIdentity();return e.translate(-M,-I),e.scale(a*w,-a*w),e.translate(n*w/2+l,s*w/2+l),f.clearRect(0,0,o.width,o.height),new T(f,this._cimResourceManager,e,!0).drawSymbol(v,y),f.getImageData(0,0,o.width,o.height)}}function O(p,m,n,s){return m==="esriGeometryPolygon"?{rings:G(S(p.rings,{xmin:0,ymin:0,xmax:n,ymax:s,width:n,height:s}),-1*n/2,-1*s/2)}:m==="esriGeometryPolyline"?{paths:G(S(p.paths,{xmin:0,ymin:0,xmax:n,ymax:s,width:n,height:s}),-1*n/2,-1*s/2)}:null}function k(p,m,n,s,M){const a=-m/2+1,c=m/2-1,l=n/2-1,y=-n/2+1;if(M&&(p==="esriGeometryPolygon"||p==="esriGeometryPolyline")){const x=O(M,p,m,n);if(x)return x}switch(p){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[a,0],[0,0],[c,0]]]};default:return s==="legend"?{rings:[[[a,l],[c,0],[c,y],[a,y],[a,l]]]}:{rings:[[[a,l],[c,l],[c,y],[a,y],[a,l]]]}}}export{tt as CIMSymbolRasterizer};
